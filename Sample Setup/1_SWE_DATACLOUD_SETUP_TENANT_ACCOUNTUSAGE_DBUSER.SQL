ALTER SESSION SET QUERY_TAG= 'TICKET#:RITM001874648,CR#:CHG000926911';

USE ROLE SYSADMIN;
USE SCHEMA ACDP_PLATFORM_DB.PLATFORM_APP;

--SELECT * FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST;


INSERT INTO
ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST
with l_mapping as
(
select
  16 tenant_id,
  'SWE DATACLOUD' tenant_name,
  'SWE_DATACLOUD' tenant_abbreviation,
  'Y' active,
  'SWE_DATACLOUD_%' match_pattern,
  1 priority_no,
  object_construct('tenant', 'SWE_DATACLOUD', 'alert_email_list','ACDP_Platform_Engineering@group.apple.com,swe-sdp-data-cloud@group.apple.com')  tag_json
)
select
     lm.tenant_id
    ,lm.tenant_name
    ,lm.tenant_abbreviation
    ,lm.active
    ,lm.match_pattern
    ,lm.priority_no
    ,lm.tag_json
    ,current_timestamp
from
    l_mapping lm
where
    lm.tag_json is not null
;
 
-- Local Sysadmin Setup

USE ROLE SECURITYADMIN;

CREATE ROLE IF NOT EXISTS SWE_DATACLOUD_SYSADMIN_ROLE;
GRANT ROLE SWE_DATACLOUD_SYSADMIN_ROLE TO ROLE SYSADMIN;

CREATE ROLE IF NOT EXISTS SWE_DATACLOUD_ETL_MONITOR_READ_ROLE;
CREATE ROLE IF NOT EXISTS SWE_DATACLOUD_ADHOC_MONITOR_READ_ROLE;
CREATE ROLE IF NOT EXISTS SWE_DATACLOUD_OTHER_MONITOR_READ_ROLE;


GRANT ROLE SWE_DATACLOUD_ETL_MONITOR_READ_ROLE TO ROLE SYSADMIN;
GRANT ROLE SWE_DATACLOUD_ADHOC_MONITOR_READ_ROLE TO ROLE SYSADMIN;
GRANT ROLE SWE_DATACLOUD_OTHER_MONITOR_READ_ROLE TO ROLE SYSADMIN;



-- Grant Warehouse Monitor Roles to Local Admin
GRANT ROLE SWE_DATACLOUD_ETL_MONITOR_READ_ROLE TO ROLE SWE_DATACLOUD_SYSADMIN_ROLE;
GRANT ROLE SWE_DATACLOUD_ADHOC_MONITOR_READ_ROLE TO ROLE SWE_DATACLOUD_SYSADMIN_ROLE;
GRANT ROLE SWE_DATACLOUD_OTHER_MONITOR_READ_ROLE TO ROLE SWE_DATACLOUD_SYSADMIN_ROLE;

-- Grant Account Usage Role to Local Admin
USE ROLE SECURITYADMIN;
CREATE ROLE IF NOT EXISTS ACDP_PLATFORM_DB_ACCOUNT_USAGE_SWE_DATACLOUD_READ_ROLE;
GRANT ROLE ACDP_PLATFORM_DB_ACCOUNT_USAGE_SWE_DATACLOUD_READ_ROLE TO ROLE SYSADMIN;
GRANT ROLE ACDP_PLATFORM_DB_ACCOUNT_USAGE_SWE_DATACLOUD_READ_ROLE TO ROLE SWE_DATACLOUD_SYSADMIN_ROLE;

--- FOR STORED PROCEDURES
USE ROLE SECURITYADMIN;
CREATE ROLE IF NOT EXISTS ACDP_PLATFORM_DB_PLATFORM_ROUTINE_USAGE_ROLE;
GRANT ROLE ACDP_PLATFORM_DB_PLATFORM_ROUTINE_USAGE_ROLE TO ROLE SYSADMIN;

GRANT ROLE ACDP_PLATFORM_DB_PLATFORM_ROUTINE_USAGE_ROLE TO ROLE SWE_DATACLOUD_SYSADMIN_ROLE;

-- _ALL_USERS_READ_ROLE
USE ROLE SECURITYADMIN;
CREATE ROLE IF NOT EXISTS SWE_DATACLOUD_ALL_USERS_READ_ROLE;
GRANT ROLE SWE_DATACLOUD_ALL_USERS_READ_ROLE TO ROLE SYSADMIN;
GRANT ROLE SWE_DATACLOUD_ALL_USERS_READ_ROLE TO ROLE SWE_DATACLOUD_SYSADMIN_ROLE;

-- VALIDATE
--USE ROLE SWE_DATACLOUD_SYSADMIN_ROLE;




-----

--setup account usage


-- NOTE / ALERT
-- UPDATE TENANT ID ACTUAL NUMBER IN THE STATEMENT BELOW IN SCRIPT
--default value is set to 1 as WHERE TENANT_ID = 16, value 1 must be change to actual tenant id being setup
-- (SELECT TENANT_ABBREVIATION || '_%' AS NAME FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST WHERE TENANT_ID = <tenant_id_here>);



USE ROLE SYSADMIN;
USE DATABASE ACDP_PLATFORM_DB;

CREATE SCHEMA IF NOT EXISTS ACDP_PLATFORM_DB.ACCOUNT_USAGE_SWE_DATACLOUD
 COMMENT = 'SWE_DATACLOUD Account Usage Views';

USE SCHEMA ACDP_PLATFORM_DB.ACCOUNT_USAGE_SWE_DATACLOUD;


USE ROLE SECURITYADMIN;
CREATE ROLE IF NOT EXISTS
    ACDP_PLATFORM_DB_ACCOUNT_USAGE_SWE_DATACLOUD_READ_ROLE;

GRANT ROLE ACDP_PLATFORM_DB_ACCOUNT_USAGE_SWE_DATACLOUD_READ_ROLE TO ROLE SYSADMIN;


GRANT USAGE ON DATABASE ACDP_PLATFORM_DB TO ROLE
    ACDP_PLATFORM_DB_ACCOUNT_USAGE_SWE_DATACLOUD_READ_ROLE;

GRANT USAGE ON SCHEMA ACCOUNT_USAGE_SWE_DATACLOUD TO
    ROLE ACDP_PLATFORM_DB_ACCOUNT_USAGE_SWE_DATACLOUD_READ_ROLE;

GRANT SELECT ON ALL VIEWS IN SCHEMA ACCOUNT_USAGE_SWE_DATACLOUD TO ROLE
    ACDP_PLATFORM_DB_ACCOUNT_USAGE_SWE_DATACLOUD_READ_ROLE;

GRANT SELECT ON FUTURE VIEWS IN SCHEMA ACCOUNT_USAGE_SWE_DATACLOUD TO ROLE
    ACDP_PLATFORM_DB_ACCOUNT_USAGE_SWE_DATACLOUD_READ_ROLE;

CREATE ROLE IF NOT EXISTS SWE_DATACLOUD_SYSADMIN_ROLE;
GRANT ROLE SWE_DATACLOUD_SYSADMIN_ROLE TO ROLE SYSADMIN;
GRANT ROLE ACDP_PLATFORM_DB_ACCOUNT_USAGE_SWE_DATACLOUD_READ_ROLE TO ROLE
    SWE_DATACLOUD_SYSADMIN_ROLE;


USE ROLE SYSADMIN;
USE DATABASE ACDP_PLATFORM_DB;
USE SCHEMA ACCOUNT_USAGE_SWE_DATACLOUD;


--DATABASES
CREATE OR REPLACE VIEW DATABASES AS
SELECT
    DATABASE_ID,
	DATABASE_NAME,
	DATABASE_OWNER,
	IS_TRANSIENT,
	COMMENT,
	CREATED,
	LAST_ALTERED,
	DELETED,
	RETENTION_TIME FROM SNOWFLAKE.ACCOUNT_USAGE.DATABASES WHERE DATABASE_NAME LIKE ANY
    (SELECT TENANT_ABBREVIATION || '_%' AS NAME FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST WHERE TENANT_ID = 16);

--COLUMNS
CREATE OR REPLACE VIEW COLUMNS AS
SELECT COLUMN_ID,
	COLUMN_NAME,
	TABLE_ID,
	TABLE_NAME,
	TABLE_SCHEMA_ID,
	TABLE_SCHEMA,
	TABLE_CATALOG_ID,
	TABLE_CATALOG,
	ORDINAL_POSITION,
	COLUMN_DEFAULT,
	IS_NULLABLE,
	DATA_TYPE,
	CHARACTER_MAXIMUM_LENGTH,
	CHARACTER_OCTET_LENGTH,
	NUMERIC_PRECISION,
	NUMERIC_PRECISION_RADIX,
	NUMERIC_SCALE,
	DATETIME_PRECISION,
	INTERVAL_TYPE,
	INTERVAL_PRECISION,
	CHARACTER_SET_CATALOG,
	CHARACTER_SET_SCHEMA,
	CHARACTER_SET_NAME,
	COLLATION_CATALOG,
	COLLATION_SCHEMA,
	COLLATION_NAME,
	DOMAIN_CATALOG,
	DOMAIN_SCHEMA,
	DOMAIN_NAME,
	UDT_CATALOG,
	UDT_SCHEMA,
	UDT_NAME,
	SCOPE_CATALOG,
	SCOPE_SCHEMA,
	SCOPE_NAME,
	MAXIMUM_CARDINALITY,
	DTD_IDENTIFIER,
	IS_SELF_REFERENCING,
	IS_IDENTITY,
	IDENTITY_GENERATION,
	IDENTITY_START,
	IDENTITY_INCREMENT,
	IDENTITY_MAXIMUM,
	IDENTITY_MINIMUM,
	IDENTITY_CYCLE,
	COMMENT,
	DELETED FROM SNOWFLAKE.ACCOUNT_USAGE.COLUMNS C WHERE TABLE_CATALOG LIKE
    (SELECT TENANT_ABBREVIATION || '_%' AS NAME FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST WHERE TENANT_ID = 16);

--VIEWS
CREATE OR REPLACE VIEW VIEWS AS
SELECT TABLE_ID,
	TABLE_NAME,
	TABLE_SCHEMA_ID,
	TABLE_SCHEMA,
	TABLE_CATALOG_ID,
	TABLE_CATALOG,
	TABLE_OWNER,
	VIEW_DEFINITION,
	CHECK_OPTION,
	IS_UPDATABLE,
	INSERTABLE_INTO,
	IS_SECURE,
	CREATED,
	LAST_ALTERED,
	DELETED,
	COMMENT FROM SNOWFLAKE.ACCOUNT_USAGE.VIEWS V WHERE TABLE_CATALOG LIKE
    (SELECT TENANT_ABBREVIATION || '_%' AS NAME FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST WHERE TENANT_ID = 16);

--SCHEMATA
CREATE OR REPLACE VIEW SCHEMATA AS
SELECT SCHEMA_ID,
	SCHEMA_NAME,
	CATALOG_ID,
	CATALOG_NAME,
	SCHEMA_OWNER,
	RETENTION_TIME,
	IS_TRANSIENT,
	IS_MANAGED_ACCESS,
	DEFAULT_CHARACTER_SET_CATALOG,
	DEFAULT_CHARACTER_SET_SCHEMA,
	DEFAULT_CHARACTER_SET_NAME,
	SQL_PATH,
	COMMENT,
	CREATED,
	LAST_ALTERED,
	DELETED FROM SNOWFLAKE.ACCOUNT_USAGE.SCHEMATA S WHERE CATALOG_NAME LIKE
    (SELECT TENANT_ABBREVIATION || '_%' AS NAME FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST WHERE TENANT_ID = 16);

--TABLES
CREATE OR REPLACE VIEW TABLES AS
SELECT 	TABLE_ID,
	TABLE_NAME,
	TABLE_SCHEMA_ID,
	TABLE_SCHEMA,
	TABLE_CATALOG_ID,
	TABLE_CATALOG,
	TABLE_OWNER,
	TABLE_TYPE,
	IS_TRANSIENT,
	CLUSTERING_KEY,
	ROW_COUNT,
	BYTES,
	RETENTION_TIME,
	SELF_REFERENCING_COLUMN_NAME,
	REFERENCE_GENERATION,
	USER_DEFINED_TYPE_CATALOG,
	USER_DEFINED_TYPE_SCHEMA,
	USER_DEFINED_TYPE_NAME,
	IS_INSERTABLE_INTO,
	IS_TYPED,
	COMMIT_ACTION,
	CREATED,
	LAST_ALTERED,
	DELETED,
	AUTO_CLUSTERING_ON,
	COMMENT FROM SNOWFLAKE.ACCOUNT_USAGE.TABLES S WHERE TABLE_CATALOG LIKE
    (SELECT TENANT_ABBREVIATION || '_%' AS NAME FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST WHERE TENANT_ID = 16);

--STAGES
CREATE OR REPLACE VIEW STAGES AS
SELECT STAGE_ID,
	STAGE_NAME,
	STAGE_SCHEMA_ID,
	STAGE_SCHEMA,
	STAGE_CATALOG_ID,
	STAGE_CATALOG,
	STAGE_URL,
	STAGE_REGION,
	STAGE_TYPE,
	STAGE_OWNER,
	COMMENT,
	CREATED,
	LAST_ALTERED,
	DELETED FROM SNOWFLAKE.ACCOUNT_USAGE.STAGES S WHERE STAGE_CATALOG LIKE
    (SELECT TENANT_ABBREVIATION || '_%' AS NAME FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST WHERE TENANT_ID = 16);

-- WAREHOUSE LOAD HISTORY
CREATE OR REPLACE VIEW WAREHOUSE_LOAD_HISTORY AS
 SELECT START_TIME,
	END_TIME,
	WAREHOUSE_ID,
	WAREHOUSE_NAME,
	AVG_RUNNING,
	AVG_QUEUED_LOAD,
	AVG_QUEUED_PROVISIONING,
	AVG_BLOCKED FROM SNOWFLAKE.ACCOUNT_USAGE.WAREHOUSE_LOAD_HISTORY WHERE WAREHOUSE_NAME LIKE
    (SELECT TENANT_ABBREVIATION || '_%' AS NAME FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST WHERE TENANT_ID = 16);

-- WAREHOUSE EVENTS HISTORY
CREATE OR REPLACE VIEW WAREHOUSE_EVENTS_HISTORY as
 SELECT TIMESTAMP,
	WAREHOUSE_ID,
	WAREHOUSE_NAME,
	CLUSTER_NUMBER,
	EVENT_NAME,
	EVENT_REASON,
	EVENT_STATE,
	USER_NAME,
	ROLE_NAME,
	QUERY_ID FROM SNOWFLAKE.ACCOUNT_USAGE.WAREHOUSE_EVENTS_HISTORY WHERE WAREHOUSE_NAME LIKE
     (SELECT TENANT_ABBREVIATION || '_%' AS NAME FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST WHERE TENANT_ID = 16);

-- ROLES
CREATE OR REPLACE VIEW ROLES as
 SELECT
    CREATED_ON,
	DELETED_ON,
	NAME,
	COMMENT FROM SNOWFLAKE.ACCOUNT_USAGE.ROLES WHERE NAME LIKE
        (SELECT TENANT_ABBREVIATION || '_%' AS NAME FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST WHERE TENANT_ID = 16);

-- GRANTS TO USERS
CREATE OR REPLACE VIEW GRANTS_TO_USERS as
 SELECT
    CREATED_ON,
	DELETED_ON,
	ROLE,
	GRANTED_TO,
	GRANTEE_NAME,
	GRANTED_BY FROM SNOWFLAKE.ACCOUNT_USAGE.GRANTS_TO_USERS WHERE ROLE LIKE
        (SELECT TENANT_ABBREVIATION || '_%' AS NAME FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST WHERE TENANT_ID = 16);

-- GRANTS TO ROLES
CREATE OR REPLACE VIEW ACDP_PLATFORM_DB.ACCOUNT_USAGE_SWE_DATACLOUD.GRANTS_TO_ROLES as
SELECT
	CREATED_ON
	,MODIFIED_ON
	,PRIVILEGE
	,GRANTED_ON
	,NAME
	,TABLE_CATALOG
	,TABLE_SCHEMA
	,GRANTED_TO
	,GRANTEE_NAME
	,GRANT_OPTION
	,GRANTED_BY
	,DELETED_ON
FROM SNOWFLAKE.ACCOUNT_USAGE.GRANTS_TO_ROLES
    WHERE GRANTEE_NAME LIKE (SELECT TENANT_ABBREVIATION || '_%' AS TENANT_NAME FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST WHERE TENANT_ID = 16) OR
          NAME LIKE (SELECT TENANT_ABBREVIATION || '_%' AS TENANT_NAME FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST WHERE TENANT_ID = 16) OR
          TABLE_CATALOG LIKE (SELECT TENANT_ABBREVIATION || '_%' AS TENANT_NAME FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST WHERE TENANT_ID = 16);


-- USERS -- Gap-> Will only bring up users that have been assigned SWE_DATACLOUD_* roles
CREATE OR REPLACE VIEW USERS AS
WITH TENANT_USER AS (
  SELECT DISTINCT GRANTEE_NAME
  FROM ACDP_PLATFORM_DB.ACCOUNT_USAGE_SWE_DATACLOUD.GRANTS_TO_USERS)
SELECT 	NAME,
	CREATED_ON,
	DELETED_ON,
	LOGIN_NAME,
	DISPLAY_NAME,
	FIRST_NAME,
	LAST_NAME,
	EMAIL,
	MUST_CHANGE_PASSWORD,
	HAS_PASSWORD,
	COMMENT,
	DISABLED,
	SNOWFLAKE_LOCK,
	DEFAULT_WAREHOUSE,
	DEFAULT_NAMESPACE,
	DEFAULT_ROLE,
	EXT_AUTHN_DUO,
	EXT_AUTHN_UID,
	BYPASS_MFA_UNTIL,
	LAST_SUCCESS_LOGIN,
	EXPIRES_AT,
	LOCKED_UNTIL_TIME,
	HAS_RSA_PUBLIC_KEY,
	PASSWORD_LAST_SET_TIME
    FROM SNOWFLAKE.ACCOUNT_USAGE.USERS U
    INNER JOIN TENANT_USER T ON T.GRANTEE_NAME = U.NAME;

--SESSIONS
CREATE OR REPLACE VIEW SESSIONS as
WITH TENANT_USER as (
 SELECT NAME as USER_NAME FROM ACDP_PLATFORM_DB.ACCOUNT_USAGE_SWE_DATACLOUD.USERS )
SELECT
    U.SESSION_ID,
	U.CREATED_ON,
	U.USER_NAME,
	U.AUTHENTICATION_METHOD,
	U.LOGIN_EVENT_ID,
	U.CLIENT_APPLICATION_VERSION,
	U.CLIENT_APPLICATION_ID,
	U.CLIENT_ENVIRONMENT,
	U.CLIENT_BUILD_ID,
	U.CLIENT_VERSION FROM  SNOWFLAKE.ACCOUNT_USAGE.SESSIONS U INNER JOIN TENANT_USER  T on T.USER_NAME=U.USER_NAME;

-- QUERY_HISTORY
CREATE OR REPLACE VIEW QUERY_HISTORY AS
SELECT QUERY_ID,
	QUERY_TEXT,
	DATABASE_ID,
	DATABASE_NAME,
	SCHEMA_ID,
	SCHEMA_NAME,
	QUERY_TYPE,
	SESSION_ID,
	USER_NAME,
	ROLE_NAME,
	WAREHOUSE_ID,
	WAREHOUSE_NAME,
	WAREHOUSE_SIZE,
	WAREHOUSE_TYPE,
	CLUSTER_NUMBER,
	QUERY_TAG,
	EXECUTION_STATUS,
	ERROR_CODE,
	ERROR_MESSAGE,
	START_TIME,
	END_TIME,
	TOTAL_ELAPSED_TIME,
	BYTES_SCANNED,
	PERCENTAGE_SCANNED_FROM_CACHE,
	BYTES_WRITTEN,
	BYTES_WRITTEN_TO_RESULT,
	BYTES_READ_FROM_RESULT,
	ROWS_PRODUCED,
	ROWS_INSERTED,
	ROWS_UPDATED,
	ROWS_DELETED,
	ROWS_UNLOADED,
	BYTES_DELETED,
	PARTITIONS_SCANNED,
	PARTITIONS_TOTAL,
	BYTES_SPILLED_TO_LOCAL_STORAGE,
	BYTES_SPILLED_TO_REMOTE_STORAGE,
	BYTES_SENT_OVER_THE_NETWORK,
	COMPILATION_TIME,
	EXECUTION_TIME,
	QUEUED_PROVISIONING_TIME,
	QUEUED_REPAIR_TIME,
	QUEUED_OVERLOAD_TIME,
	TRANSACTION_BLOCKED_TIME,
	OUTBOUND_DATA_TRANSFER_CLOUD,
	OUTBOUND_DATA_TRANSFER_REGION,
	OUTBOUND_DATA_TRANSFER_BYTES,
	INBOUND_DATA_TRANSFER_CLOUD,
	INBOUND_DATA_TRANSFER_REGION,
	INBOUND_DATA_TRANSFER_BYTES,
	LIST_EXTERNAL_FILES_TIME,
	CREDITS_USED_CLOUD_SERVICES,
	RELEASE_VERSION,
	EXTERNAL_FUNCTION_TOTAL_INVOCATIONS,
	EXTERNAL_FUNCTION_TOTAL_SENT_ROWS,
	EXTERNAL_FUNCTION_TOTAL_RECEIVED_ROWS,
	EXTERNAL_FUNCTION_TOTAL_SENT_BYTES,
	EXTERNAL_FUNCTION_TOTAL_RECEIVED_BYTES,
	QUERY_LOAD_PERCENT,
	IS_CLIENT_GENERATED_STATEMENT FROM  SNOWFLAKE.ACCOUNT_USAGE.QUERY_HISTORY WHERE ROLE_NAME LIKE
    (SELECT TENANT_ABBREVIATION || '_%' AS NAME FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST WHERE TENANT_ID = 16); -- should I look for Warehouse Name as well?

-- COPY_HISTORY
CREATE OR REPLACE VIEW COPY_HISTORY as
 SELECT FILE_NAME,
	STAGE_LOCATION,
	LAST_LOAD_TIME,
	ROW_COUNT,
	ROW_PARSED,
	FILE_SIZE,
	FIRST_ERROR_MESSAGE,
	FIRST_ERROR_LINE_NUMBER,
	FIRST_ERROR_CHARACTER_POS,
	FIRST_ERROR_COLUMN_NAME,
	ERROR_COUNT,
	ERROR_LIMIT,
	STATUS,
	TABLE_ID,
	TABLE_NAME,
	TABLE_SCHEMA_ID,
	TABLE_SCHEMA_NAME,
	TABLE_CATALOG_ID,
	TABLE_CATALOG_NAME,
	PIPE_CATALOG_NAME,
	PIPE_SCHEMA_NAME,
	PIPE_NAME,
	PIPE_RECEIVED_TIME,
	FIRST_COMMIT_TIME FROM SNOWFLAKE.ACCOUNT_USAGE.COPY_HISTORY WHERE
 TABLE_CATALOG_NAME LIKE
     (SELECT TENANT_ABBREVIATION || '_%' AS NAME FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST WHERE TENANT_ID = 16)
     OR
 PIPE_CATALOG_NAME LIKE
     (SELECT TENANT_ABBREVIATION || '_%' AS NAME FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST WHERE TENANT_ID = 16);

-- DATABASE_STORAGE_USAGE_HISTORY
CREATE OR REPLACE VIEW DATABASE_STORAGE_USAGE_HISTORY AS
SELECT USAGE_DATE,
	DATABASE_ID,
	DATABASE_NAME,
	DELETED,
	AVERAGE_DATABASE_BYTES,
	AVERAGE_FAILSAFE_BYTES FROM  SNOWFLAKE.ACCOUNT_USAGE.DATABASE_STORAGE_USAGE_HISTORY WHERE DATABASE_NAME LIKE
    (SELECT TENANT_ABBREVIATION || '_%' AS NAME FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST WHERE TENANT_ID = 16);


-- AUTOMATIC CLUSTERING HISTORY
CREATE OR REPLACE VIEW AUTOMATIC_CLUSTERING_HISTORY as
 SELECT START_TIME,
	END_TIME,
	CREDITS_USED,
	NUM_BYTES_RECLUSTERED,
	NUM_ROWS_RECLUSTERED,
	TABLE_ID,
	TABLE_NAME,
	SCHEMA_ID,
	SCHEMA_NAME,
	DATABASE_ID,
	DATABASE_NAME FROM SNOWFLAKE.ACCOUNT_USAGE.AUTOMATIC_CLUSTERING_HISTORY WHERE DATABASE_NAME LIKE
     (SELECT TENANT_ABBREVIATION || '_%' AS NAME FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST WHERE TENANT_ID = 16);


-- FILE FORMAT
CREATE OR REPLACE VIEW FILE_FORMATS as
 SELECT FILE_FORMAT_ID,
	FILE_FORMAT_NAME,
	FILE_FORMAT_SCHEMA_ID,
	FILE_FORMAT_SCHEMA,
	FILE_FORMAT_CATALOG_ID,
	FILE_FORMAT_CATALOG,
	FILE_FORMAT_OWNER,
	FILE_FORMAT_TYPE,
	RECORD_DELIMITER,
	FIELD_DELIMITER,
	SKIP_HEADER,
	DATE_FORMAT,
	TIME_FORMAT,
	TIMESTAMP_FORMAT,
	BINARY_FORMAT,
	ESCAPE,
	ESCAPE_UNENCLOSED_FIELD,
	TRIM_SPACE,
	FIELD_OPTIONALLY_ENCLOSED_BY,
	NULL_IF,
	COMPRESSION,
	ERROR_ON_COLUMN_COUNT_MISMATCH,
	CREATED,
	LAST_ALTERED,
	DELETED,
	COMMENT FROM SNOWFLAKE.ACCOUNT_USAGE.FILE_FORMATS WHERE FILE_FORMAT_CATALOG LIKE
     (SELECT TENANT_ABBREVIATION || '_%' AS NAME FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST WHERE TENANT_ID = 16);

-- FUNCTIONS
CREATE OR REPLACE VIEW FUNCTIONS as
 SELECT FUNCTION_ID,
	FUNCTION_NAME,
	FUNCTION_SCHEMA_ID,
	FUNCTION_SCHEMA,
	FUNCTION_CATALOG_ID,
	FUNCTION_CATALOG,
	FUNCTION_OWNER,
	ARGUMENT_SIGNATURE,
	DATA_TYPE,
	CHARACTER_MAXIMUM_LENGTH,
	CHARACTER_OCTET_LENGTH,
	NUMERIC_PRECISION,
	NUMERIC_PRECISION_RADIX,
	NUMERIC_SCALE,
	FUNCTION_LANGUAGE,
	FUNCTION_DEFINITION,
	VOLATILITY,
	IS_NULL_CALL,
	CREATED,
	LAST_ALTERED,
	DELETED,
	COMMENT,
	IS_EXTERNAL,
	API_INTEGRATION,
	CONTEXT_HEADERS,
	MAX_BATCH_ROWS,
	COMPRESSION FROM SNOWFLAKE.ACCOUNT_USAGE.FUNCTIONS WHERE FUNCTION_CATALOG LIKE
     (SELECT TENANT_ABBREVIATION || '_%' AS NAME FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST WHERE TENANT_ID = 16);

-- LOAD_HISTORY
CREATE OR REPLACE VIEW LOAD_HISTORY as
 SELECT TABLE_ID,
	TABLE_NAME,
	SCHEMA_ID,
	SCHEMA_NAME,
	CATALOG_ID,
	CATALOG_NAME,
	FILE_NAME,
	LAST_LOAD_TIME,
	STATUS,
	ROW_COUNT,
	ROW_PARSED,
	FIRST_ERROR_MESSAGE,
	FIRST_ERROR_LINE_NUMBER,
	FIRST_ERROR_CHARACTER_POSITION,
	FIRST_ERROR_COL_NAME,
	ERROR_COUNT,
	ERROR_LIMIT FROM SNOWFLAKE.ACCOUNT_USAGE.LOAD_HISTORY WHERE CATALOG_NAME LIKE
     (SELECT TENANT_ABBREVIATION || '_%' AS NAME FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST WHERE TENANT_ID = 16);

-- MASKING_POLICIES
CREATE OR REPLACE VIEW MASKING_POLICIES as
 SELECT POLICY_ID,
	POLICY_NAME,
	POLICY_SCHEMA_ID,
	POLICY_SCHEMA,
	POLICY_CATALOG_ID,
	POLICY_CATALOG,
	POLICY_OWNER,
	POLICY_SIGNATURE,
	POLICY_RETURN_TYPE,
	POLICY_BODY,
	POLICY_COMMENT,
	CREATED,
	LAST_ALTERED,
	DELETED FROM SNOWFLAKE.ACCOUNT_USAGE.MASKING_POLICIES WHERE POLICY_CATALOG LIKE
     (SELECT TENANT_ABBREVIATION || '_%' AS NAME FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST WHERE TENANT_ID = 16);


-- MATERIALIZED_VIEW_REFRESH_HISTORY
CREATE OR REPLACE VIEW MATERIALIZED_VIEW_REFRESH_HISTORY as
 SELECT START_TIME,
	END_TIME,
	CREDITS_USED,
	TABLE_ID,
	TABLE_NAME,
	SCHEMA_ID,
	SCHEMA_NAME,
	DATABASE_ID,
	DATABASE_NAME FROM SNOWFLAKE.ACCOUNT_USAGE.MATERIALIZED_VIEW_REFRESH_HISTORY WHERE DATABASE_NAME LIKE
     (SELECT TENANT_ABBREVIATION || '_%' AS NAME FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST WHERE TENANT_ID = 16);


-- PIPES
CREATE OR REPLACE VIEW PIPES as
 SELECT PIPE_ID,
	PIPE_NAME,
	PIPE_SCHEMA_ID,
	PIPE_SCHEMA,
	PIPE_CATALOG_ID,
	PIPE_CATALOG,
	IS_AUTOINGEST_ENABLED,
	NOTIFICATION_CHANNEL_NAME,
	PIPE_OWNER,
	DEFINITION,
	CREATED,
	LAST_ALTERED,
	COMMENT,
	PATTERN,
	DELETED FROM SNOWFLAKE.ACCOUNT_USAGE.PIPES WHERE PIPE_CATALOG LIKE
     (SELECT TENANT_ABBREVIATION || '_%' AS NAME FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST WHERE TENANT_ID = 16);

-- PIPE_USAGE_HISTORY
CREATE OR REPLACE VIEW PIPE_USAGE_HISTORY as
 SELECT
    PH.PIPE_ID,
	PH.PIPE_NAME,
	PH.START_TIME,
	PH.END_TIME,
	PH.CREDITS_USED,
	PH.BYTES_INSERTED,
	PH.FILES_INSERTED FROM SNOWFLAKE.ACCOUNT_USAGE.PIPE_USAGE_HISTORY PH
    INNER JOIN ACDP_PLATFORM_DB.ACCOUNT_USAGE_SWE_DATACLOUD.PIPES P
        ON PH.PIPE_ID = P.PIPE_ID
    INNER JOIN ACDP_PLATFORM_DB.ACCOUNT_USAGE_SWE_DATACLOUD.DATABASES D
        ON D.DATABASE_NAME = P.PIPE_CATALOG;

-- POLICY_REFERENCES
CREATE OR REPLACE VIEW POLICY_REFERENCES as
 SELECT POLICY_DB,
	POLICY_SCHEMA,
	POLICY_ID,
	POLICY_NAME,
	POLICY_KIND,
	REF_DATABASE_NAME,
	REF_SCHEMA_NAME,
	REF_ENTITY_NAME,
	REF_ENTITY_DOMAIN,
	REF_COLUMN_NAME,
	REF_ARG_COLUMN_NAMES FROM SNOWFLAKE.ACCOUNT_USAGE.POLICY_REFERENCES WHERE POLICY_DB LIKE
     (SELECT TENANT_ABBREVIATION || '_%' AS NAME FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST WHERE TENANT_ID = 16);

-- REFERENTIAL_CONSTRAINTS
CREATE OR REPLACE VIEW REFERENTIAL_CONSTRAINTS as
 SELECT CONSTRAINT_CATALOG_ID,
	CONSTRAINT_CATALOG,
	CONSTRAINT_SCHEMA_ID,
	CONSTRAINT_SCHEMA,
	CONSTRAINT_NAME,
	UNIQUE_CONSTRAINT_CATALOG_ID,
	UNIQUE_CONSTRAINT_CATALOG,
	UNIQUE_CONSTRAINT_SCHEMA_ID,
	UNIQUE_CONSTRAINT_SCHEMA,
	UNIQUE_CONSTRAINT_NAME,
	MATCH_OPTION,
	UPDATE_RULE,
	DELETE_RULE,
	COMMENT,
	CREATED,
	LAST_ALTERED,
	DELETED FROM SNOWFLAKE.ACCOUNT_USAGE.REFERENTIAL_CONSTRAINTS WHERE CONSTRAINT_CATALOG LIKE
     (SELECT TENANT_ABBREVIATION || '_%' AS NAME FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST WHERE TENANT_ID = 16);


-- REPLICATION_USAGE_HISTORY
CREATE OR REPLACE VIEW REPLICATION_USAGE_HISTORY as
 SELECT START_TIME,
	END_TIME,
	DATABASE_NAME,
	DATABASE_ID,
	CREDITS_USED,
	BYTES_TRANSFERRED FROM SNOWFLAKE.ACCOUNT_USAGE.REPLICATION_USAGE_HISTORY WHERE DATABASE_NAME LIKE
     (SELECT TENANT_ABBREVIATION || '_%' AS NAME FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST WHERE TENANT_ID = 16);


-- ROW_ACCESS_POLICIES
CREATE OR REPLACE VIEW ROW_ACCESS_POLICIES as
 SELECT POLICY_ID
,POLICY_NAME
,POLICY_SCHEMA_ID
,POLICY_SCHEMA
,POLICY_CATALOG_ID
,POLICY_CATALOG
,POLICY_OWNER
,POLICY_SIGNATURE
,POLICY_RETURN_TYPE
,POLICY_BODY
,POLICY_COMMENT
,CREATED
,LAST_ALTERED
,DELETED
FROM SNOWFLAKE.ACCOUNT_USAGE.ROW_ACCESS_POLICIES WHERE POLICY_CATALOG LIKE
     (SELECT TENANT_ABBREVIATION || '_%' AS NAME FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST WHERE TENANT_ID = 16);


-- SEARCH_OPTIMIZATION_HISTORY
CREATE OR REPLACE VIEW SEARCH_OPTIMIZATION_HISTORY as
 SELECT START_TIME,
	END_TIME,
	CREDITS_USED,
	TABLE_ID,
	TABLE_NAME,
	SCHEMA_ID,
	SCHEMA_NAME,
	DATABASE_ID,
	DATABASE_NAME FROM SNOWFLAKE.ACCOUNT_USAGE.SEARCH_OPTIMIZATION_HISTORY WHERE DATABASE_NAME LIKE
     (SELECT TENANT_ABBREVIATION || '_%' AS NAME FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST WHERE TENANT_ID = 16);


-- SEQUENCES
CREATE OR REPLACE VIEW SEQUENCES as
 SELECT SEQUENCE_ID,
	SEQUENCE_NAME,
	SEQUENCE_SCHEMA_ID,
	SEQUENCE_SCHEMA,
	SEQUENCE_CATALOG_ID,
	SEQUENCE_CATALOG,
	SEQUENCE_OWNER,
	DATA_TYPE,
	NUMERIC_PRECISION,
	NUMERIC_PRECISION_RADIX,
	NUMERIC_SCALE,
	START_VALUE,
	MINIMUM_VALUE,
	MAXIMUM_VALUE,
	NEXT_VALUE,
	"INCREMENT",
	CYCLE_OPTION,
	CREATED,
	LAST_ALTERED,
	DELETED,
	COMMENT FROM SNOWFLAKE.ACCOUNT_USAGE.SEQUENCES WHERE SEQUENCE_CATALOG LIKE
     (SELECT TENANT_ABBREVIATION || '_%' AS NAME FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST WHERE TENANT_ID = 16);

-- TAGS
CREATE OR REPLACE VIEW TAGS as
 SELECT TAG_ID,
	TAG_NAME,
	TAG_SCHEMA_ID,
	TAG_SCHEMA,
	TAG_DATABASE_ID,
	TAG_DATABASE,
	TAG_OWNER,
	TAG_COMMENT,
	CREATED,
	LAST_ALTERED,
	DELETED FROM SNOWFLAKE.ACCOUNT_USAGE.TAGS WHERE TAG_DATABASE LIKE
     (SELECT TENANT_ABBREVIATION || '_%' AS NAME FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST WHERE TENANT_ID = 16);


-- TAG_REFERENCES; CONFIRM TAG_DATABASE
CREATE OR REPLACE VIEW TAG_REFERENCES as
 SELECT TAG_ID,
	TAG_NAME,
	TAG_SCHEMA_ID,
	TAG_SCHEMA,
	TAG_DATABASE_ID,
	TAG_DATABASE,
	TAG_OWNER,
	TAG_COMMENT,
	CREATED,
	LAST_ALTERED,
	DELETED FROM SNOWFLAKE.ACCOUNT_USAGE.TAGS WHERE TAG_DATABASE LIKE
     (SELECT TENANT_ABBREVIATION || '_%' AS NAME FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST WHERE TENANT_ID = 16);


-- SERVERLESS TASK HISTORY
CREATE OR REPLACE VIEW SERVERLESS_TASK_HISTORY as
 SELECT START_TIME,
	END_TIME,
	CREDITS_USED,
	TASK_ID,
	TASK_NAME,
	SCHEMA_ID,
	SCHEMA_NAME,
	DATABASE_ID,
	DATABASE_NAME FROM SNOWFLAKE.ACCOUNT_USAGE.SERVERLESS_TASK_HISTORY WHERE DATABASE_NAME LIKE
     (SELECT TENANT_ABBREVIATION || '_%' AS NAME FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST WHERE TENANT_ID = 16);


-- ACCESS_HISTORY
CREATE OR REPLACE VIEW ACCESS_HISTORY as
 SELECT 	QUERY_ID,
	QUERY_START_TIME,
	USER_NAME,
	DIRECT_OBJECTS_ACCESSED,
	BASE_OBJECTS_ACCESSED,
	OBJECTS_MODIFIED FROM SNOWFLAKE.ACCOUNT_USAGE.ACCESS_HISTORY H
    INNER JOIN ACDP_PLATFORM_DB.ACCOUNT_USAGE_SWE_DATACLOUD.USERS U ON U.NAME = H.USER_NAME;

-- LOGIN HISTORY
CREATE OR REPLACE VIEW ACDP_PLATFORM_DB.ACCOUNT_USAGE_SWE_DATACLOUD.LOGIN_HISTORY(
	EVENT_ID,
	EVENT_TIMESTAMP,
	EVENT_TYPE,
	USER_NAME,
	CLIENT_IP,
	REPORTED_CLIENT_TYPE,
	REPORTED_CLIENT_VERSION,
	FIRST_AUTHENTICATION_FACTOR,
	SECOND_AUTHENTICATION_FACTOR,
	IS_SUCCESS,
	ERROR_CODE,
	ERROR_MESSAGE,
	RELATED_EVENT_ID,
	CONNECTION
) as
 SELECT EVENT_ID,
	EVENT_TIMESTAMP,
	EVENT_TYPE,
	USER_NAME,
	CLIENT_IP,
	REPORTED_CLIENT_TYPE,
	REPORTED_CLIENT_VERSION,
	FIRST_AUTHENTICATION_FACTOR,
	SECOND_AUTHENTICATION_FACTOR,
	IS_SUCCESS,
	ERROR_CODE,
	ERROR_MESSAGE,
	RELATED_EVENT_ID,
	CONNECTION
    FROM SNOWFLAKE.ACCOUNT_USAGE.LOGIN_HISTORY L
    INNER JOIN ACDP_PLATFORM_DB.ACCOUNT_USAGE_SWE_DATACLOUD.USERS U ON U.NAME = L.USER_NAME;

-- METERING HISTORY
CREATE OR REPLACE VIEW METERING_HISTORY as
 SELECT 	SERVICE_TYPE,
	START_TIME,
	END_TIME,
	ENTITY_ID,
	NAME,
	CREDITS_USED_COMPUTE,
	CREDITS_USED_CLOUD_SERVICES,
	CREDITS_USED,
	BYTES,
	"ROWS",
	FILES FROM SNOWFLAKE.ACCOUNT_USAGE.METERING_HISTORY WHERE NAME LIKE
     (SELECT TENANT_ABBREVIATION || '_%' AS NAME FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST WHERE TENANT_ID = 16);

-- TABLE_CONSTRAINTS
CREATE OR REPLACE VIEW TABLE_CONSTRAINTS as
 SELECT CONSTRAINT_ID,
	CONSTRAINT_NAME,
	CONSTRAINT_SCHEMA_ID,
	CONSTRAINT_SCHEMA,
	CONSTRAINT_CATALOG_ID,
	CONSTRAINT_CATALOG,
	TABLE_ID,
	TABLE_NAME,
	TABLE_SCHEMA_ID,
	TABLE_SCHEMA,
	TABLE_CATALOG_ID,
	TABLE_CATALOG,
	CONSTRAINT_TYPE,
	IS_DEFERRABLE,
	INITIALLY_DEFERRED,
	ENFORCED,
	COMMENT,
	CREATED,
	LAST_ALTERED,
	DELETED FROM SNOWFLAKE.ACCOUNT_USAGE.TABLE_CONSTRAINTS WHERE CONSTRAINT_CATALOG LIKE
     (SELECT TENANT_ABBREVIATION || '_%' AS NAME FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST WHERE TENANT_ID = 16);

-- TABLE_STORAGE_METRICS
CREATE OR REPLACE VIEW TABLE_STORAGE_METRICS as
 SELECT ID,
	TABLE_NAME,
	TABLE_SCHEMA_ID,
	TABLE_SCHEMA,
	TABLE_CATALOG_ID,
	TABLE_CATALOG,
	CLONE_GROUP_ID,
	IS_TRANSIENT,
	ACTIVE_BYTES,
	TIME_TRAVEL_BYTES,
	FAILSAFE_BYTES,
	RETAINED_FOR_CLONE_BYTES,
	DELETED,
	TABLE_CREATED,
	TABLE_DROPPED,
	TABLE_ENTERED_FAILSAFE,
	SCHEMA_CREATED,
	SCHEMA_DROPPED,
	CATALOG_CREATED,
	CATALOG_DROPPED,
	COMMENT FROM SNOWFLAKE.ACCOUNT_USAGE.TABLE_STORAGE_METRICS WHERE TABLE_CATALOG LIKE
     (SELECT TENANT_ABBREVIATION || '_%' AS NAME FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST WHERE TENANT_ID = 16);

-- WAREHOUSE_METERING_HISTORY
CREATE OR REPLACE VIEW WAREHOUSE_METERING_HISTORY as
 SELECT START_TIME,
	END_TIME,
	WAREHOUSE_ID,
	WAREHOUSE_NAME,
	CREDITS_USED,
	CREDITS_USED_COMPUTE,
	CREDITS_USED_CLOUD_SERVICES FROM SNOWFLAKE.ACCOUNT_USAGE.WAREHOUSE_METERING_HISTORY WHERE WAREHOUSE_NAME LIKE
     (SELECT TENANT_ABBREVIATION || '_%' AS NAME FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST WHERE TENANT_ID = 16);

-- TABLES
CREATE OR REPLACE VIEW TABLES as
 SELECT TABLE_ID,
	TABLE_NAME,
	TABLE_SCHEMA_ID,
	TABLE_SCHEMA,
	TABLE_CATALOG_ID,
	TABLE_CATALOG,
	TABLE_OWNER,
	TABLE_TYPE,
	IS_TRANSIENT,
	CLUSTERING_KEY,
	ROW_COUNT,
	BYTES,
	RETENTION_TIME,
	SELF_REFERENCING_COLUMN_NAME,
	REFERENCE_GENERATION,
	USER_DEFINED_TYPE_CATALOG,
	USER_DEFINED_TYPE_SCHEMA,
	USER_DEFINED_TYPE_NAME,
	IS_INSERTABLE_INTO,
	IS_TYPED,
	COMMIT_ACTION,
	CREATED,
	LAST_ALTERED,
	DELETED,
	AUTO_CLUSTERING_ON,
	COMMENT FROM SNOWFLAKE.ACCOUNT_USAGE.TABLES WHERE TABLE_CATALOG LIKE
     (SELECT TENANT_ABBREVIATION || '_%' AS NAME FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST WHERE TENANT_ID = 16);

-- TASK_HISTORY

CREATE OR REPLACE VIEW ACDP_PLATFORM_DB.ACCOUNT_USAGE_SWE_DATACLOUD.TASK_HISTORY(
	NAME,
	QUERY_TEXT,
	CONDITION_TEXT,
	SCHEMA_NAME,
	TASK_SCHEMA_ID,
	DATABASE_NAME,
	TASK_DATABASE_ID,
	SCHEDULED_TIME,
	COMPLETED_TIME,
	STATE,
	RETURN_VALUE,
	QUERY_ID,
	QUERY_START_TIME,
	ERROR_CODE,
	ERROR_MESSAGE,
	GRAPH_VERSION,
	RUN_ID,
	ROOT_TASK_ID,
  SCHEDULED_FROM
) as
 SELECT 	NAME,
	QUERY_TEXT,
	CONDITION_TEXT,
	SCHEMA_NAME,
	TASK_SCHEMA_ID,
	DATABASE_NAME,
	TASK_DATABASE_ID,
	SCHEDULED_TIME,
	COMPLETED_TIME,
	STATE,
	RETURN_VALUE,
	QUERY_ID,
	QUERY_START_TIME,
	ERROR_CODE,
	ERROR_MESSAGE,
	GRAPH_VERSION,
	RUN_ID,
	ROOT_TASK_ID,
    SCHEDULED_FROM
    FROM SNOWFLAKE.ACCOUNT_USAGE.TASK_HISTORY WHERE DATABASE_NAME LIKE
     (SELECT TENANT_ABBREVIATION || '_%' AS NAME FROM ACDP_PLATFORM_DB.PLATFORM_APP.TENANT_LIST WHERE TENANT_ID = 16);

